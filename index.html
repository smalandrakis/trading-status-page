<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Freedom - Trading Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; }
        .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .status-ok { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-error { color: #ef4444; }
        .prob-high { background: linear-gradient(90deg, #10b981 0%, #10b981 var(--prob), transparent var(--prob)); }
        .prob-med { background: linear-gradient(90deg, #f59e0b 0%, #f59e0b var(--prob), transparent var(--prob)); }
        .prob-low { background: linear-gradient(90deg, #6b7280 0%, #6b7280 var(--prob), transparent var(--prob)); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="text-white p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-2">
                <i class="fas fa-chart-line mr-2"></i>Project Freedom
            </h1>
            <p class="text-gray-400">Trading Bot Status Dashboard</p>
            <div id="lastUpdate" class="text-sm text-gray-500 mt-2"></div>
        </div>

        <!-- Alerts -->
        <div id="alertsContainer" class="mb-6"></div>

        <!-- Bot Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- BTC Bot -->
            <div class="card rounded-xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">‚Çø</span>
                        <span class="text-xl font-bold">BTC</span>
                    </div>
                    <div id="btcStatus" class="flex items-center">
                        <span class="w-3 h-3 rounded-full bg-gray-500 mr-2"></span>
                        <span class="text-sm">Loading...</span>
                    </div>
                </div>
                <div id="btcPrice" class="text-2xl font-mono mb-2">--</div>
                <div id="btcPositions" class="text-sm text-gray-400 mb-4">Positions: --/4</div>
                <div id="btcProbs" class="space-y-2"></div>
                <div id="btcPnl" class="mt-4 pt-4 border-t border-gray-700 text-sm"></div>
            </div>

            <!-- MNQ Bot -->
            <div class="card rounded-xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">üìà</span>
                        <span class="text-xl font-bold">MNQ</span>
                    </div>
                    <div id="mnqStatus" class="flex items-center">
                        <span class="w-3 h-3 rounded-full bg-gray-500 mr-2"></span>
                        <span class="text-sm">Loading...</span>
                    </div>
                </div>
                <div id="mnqPrice" class="text-2xl font-mono mb-2">--</div>
                <div id="mnqPositions" class="text-sm text-gray-400 mb-4">Positions: --/4</div>
                <div id="mnqProbs" class="space-y-2"></div>
                <div id="mnqPnl" class="mt-4 pt-4 border-t border-gray-700 text-sm"></div>
            </div>

            <!-- SPY Bot -->
            <div class="card rounded-xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">üèõÔ∏è</span>
                        <span class="text-xl font-bold">SPY</span>
                    </div>
                    <div id="spyStatus" class="flex items-center">
                        <span class="w-3 h-3 rounded-full bg-gray-500 mr-2"></span>
                        <span class="text-sm">Loading...</span>
                    </div>
                </div>
                <div id="spyPrice" class="text-2xl font-mono mb-2">--</div>
                <div id="spyPositions" class="text-sm text-gray-400 mb-4">Positions: --/3</div>
                <div id="spyProbs" class="space-y-2"></div>
                <div id="spyPnl" class="mt-4 pt-4 border-t border-gray-700 text-sm"></div>
            </div>
        </div>

        <!-- Parquet Health & Signal Match -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Parquet Health -->
            <div class="card rounded-xl p-4">
                <h2 class="text-lg font-bold mb-4">
                    <i class="fas fa-database mr-2"></i>Parquet Health
                </h2>
                <div id="parquetHealth" class="space-y-3"></div>
            </div>

            <!-- Signal Match -->
            <div class="card rounded-xl p-4">
                <h2 class="text-lg font-bold mb-4">
                    <i class="fas fa-check-double mr-2"></i>Signal Match
                </h2>
                <div id="signalMatch" class="space-y-3"></div>
            </div>
        </div>

        <!-- Backtest Section -->
        <div class="card rounded-xl p-4 mb-6">
            <h2 class="text-lg font-bold mb-4">
                <i class="fas fa-flask mr-2"></i>BTC Backtest (24h) 
                <span id="backtestTime" class="text-sm font-normal text-gray-500 ml-2"></span>
            </h2>
            <div id="backtestContent">
                <div class="text-gray-500">Backtest runs 4x daily (00:00, 06:00, 12:00, 18:00 UTC)</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-500 text-sm">
            <p>Page refreshes every 5 min | Data updates hourly | Check #<span id="checkCount">0</span></p>
            <p class="mt-1">Project Freedom Trading System</p>
        </div>
    </div>

    <script>
        async function loadStatus() {
            try {
                const response = await fetch('status.json?' + Date.now());
                const data = await response.json();
                updateDashboard(data);
            } catch (e) {
                console.error('Error loading status:', e);
                document.getElementById('lastUpdate').innerHTML = 
                    '<span class="text-red-400"><i class="fas fa-exclamation-triangle mr-1"></i>Error loading status</span>';
            }
        }

        function updateDashboard(data) {
            // Last update
            document.getElementById('lastUpdate').innerHTML = 
                `<i class="fas fa-clock mr-1"></i>Last update: ${data.last_update || 'Never'}`;
            document.getElementById('checkCount').textContent = data.check_count || 0;

            // Alerts
            const alertsHtml = (data.alerts || []).map(a => {
                const icon = a.type === 'error' ? 'exclamation-circle' : 
                            a.type === 'warning' ? 'exclamation-triangle' : 'info-circle';
                const color = a.type === 'error' ? 'red' : a.type === 'warning' ? 'yellow' : 'blue';
                return `<div class="bg-${color}-900/50 border border-${color}-500/50 rounded-lg p-3 mb-2">
                    <i class="fas fa-${icon} mr-2 text-${color}-400"></i>
                    <span class="text-${color}-200">${a.message}</span>
                    <span class="text-${color}-400 text-xs ml-2">${a.time?.split('T')[1]?.split('.')[0] || ''}</span>
                </div>`;
            }).join('');
            document.getElementById('alertsContainer').innerHTML = alertsHtml;

            // Bot cards
            ['BTC', 'MNQ', 'SPY'].forEach(bot => {
                const botData = data.bots?.[bot] || {};
                const prefix = bot.toLowerCase();
                
                // Status
                const statusEl = document.getElementById(`${prefix}Status`);
                if (botData.running) {
                    statusEl.innerHTML = '<span class="w-3 h-3 rounded-full bg-green-500 mr-2 pulse"></span><span class="text-green-400 text-sm">Running</span>';
                } else {
                    statusEl.innerHTML = '<span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span><span class="text-red-400 text-sm">Stopped</span>';
                }

                // Price
                const price = botData.last_price;
                document.getElementById(`${prefix}Price`).textContent = 
                    price ? (bot === 'BTC' ? `$${price.toLocaleString()}` : `$${price}`) : '--';

                // Positions
                const maxPos = bot === 'SPY' ? 3 : 4;
                document.getElementById(`${prefix}Positions`).textContent = 
                    `Positions: ${botData.positions || 0}/${maxPos}`;

                // Probabilities
                const probs = botData.probabilities || {};
                const probsHtml = Object.entries(probs).map(([name, prob]) => {
                    const isShort = name.includes('SHORT');
                    const probClass = prob >= 65 ? 'prob-high' : prob >= 50 ? 'prob-med' : 'prob-low';
                    const direction = isShort ? 'üî¥' : 'üü¢';
                    return `<div class="flex items-center justify-between text-sm">
                        <span>${direction} ${name.replace('_SHORT', ' S')}</span>
                        <div class="w-24 h-5 bg-gray-700 rounded overflow-hidden">
                            <div class="${probClass} h-full rounded" style="--prob: ${prob}%; width: ${prob}%"></div>
                        </div>
                        <span class="w-12 text-right font-mono ${prob >= 65 ? 'text-green-400' : ''}">${prob}%</span>
                    </div>`;
                }).join('');
                document.getElementById(`${prefix}Probs`).innerHTML = probsHtml || '<span class="text-gray-500">No data</span>';

                // P&L
                const pnl = botData.pnl_24h || {};
                const unrealizedColor = pnl.unrealized > 0 ? 'text-green-400' : pnl.unrealized < 0 ? 'text-red-400' : 'text-gray-400';
                const realizedColor = pnl.realized > 0 ? 'text-green-400' : pnl.realized < 0 ? 'text-red-400' : 'text-gray-400';
                
                // Show open positions
                let openPosHtml = '';
                if (pnl.open_positions && pnl.open_positions.length > 0) {
                    openPosHtml = `<div class="mt-2 mb-2">
                        <div class="text-xs text-gray-500 mb-1">üìç Open Positions:</div>
                        ${pnl.open_positions.map(p => {
                            const pnlColor = p.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                            const dirIcon = p.direction === 'LONG' ? 'üü¢' : 'üî¥';
                            return `<div class="text-xs flex justify-between bg-gray-800/50 rounded px-2 py-1 mb-1">
                                <span>${dirIcon} ${p.direction} @ $${p.entry?.toLocaleString()}</span>
                                <span class="${pnlColor} font-mono">$${p.pnl}</span>
                            </div>`;
                        }).join('')}
                    </div>`;
                }
                
                // Show closed trades (last 24h)
                let closedTradesHtml = '';
                if (pnl.closed_trades && pnl.closed_trades.length > 0) {
                    closedTradesHtml = `<div class="mt-2">
                        <div class="text-xs text-gray-500 mb-1">üìã Closed (24h): ${pnl.wins}W/${pnl.losses}L</div>
                        ${pnl.closed_trades.slice(0, 5).map(t => {
                            const pnlColor = t.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                            const dirIcon = t.direction === 'LONG' ? 'üü¢' : 'üî¥';
                            const reasonIcon = t.reason === 'TAKE_PROFIT' ? '‚úÖ' : t.reason === 'STOP_LOSS' ? '‚ùå' : '‚è±Ô∏è';
                            const exitTime = t.exit_time ? t.exit_time.split(' ')[1]?.substring(0,5) || '' : '';
                            return `<div class="text-xs flex justify-between bg-gray-800/30 rounded px-2 py-1 mb-1">
                                <span>${dirIcon} ${reasonIcon} ${exitTime}</span>
                                <span class="${pnlColor} font-mono">$${t.pnl}</span>
                            </div>`;
                        }).join('')}
                        ${pnl.closed_trades.length > 5 ? `<div class="text-xs text-gray-500 text-center">+${pnl.closed_trades.length - 5} more</div>` : ''}
                    </div>`;
                }
                
                document.getElementById(`${prefix}Pnl`).innerHTML = `
                    <div class="flex justify-between">
                        <span class="text-gray-400">Unrealized:</span>
                        <span class="${unrealizedColor} font-mono">$${pnl.unrealized || 0}</span>
                    </div>
                    ${openPosHtml}
                    <div class="flex justify-between mt-1 pt-1 border-t border-gray-700">
                        <span class="text-gray-400">Realized 24h:</span>
                        <span class="${realizedColor} font-mono">$${pnl.realized || 0}</span>
                    </div>
                    ${closedTradesHtml}`;
            });

            // Parquet Health
            const parquetHtml = Object.entries(data.parquet_health || {}).map(([name, health]) => {
                const statusIcon = health.healthy ? 
                    '<i class="fas fa-check-circle text-green-400"></i>' : 
                    '<i class="fas fa-exclamation-circle text-red-400"></i>';
                const issues = (health.issues || []).join(', ') || 'OK';
                return `<div class="flex items-center justify-between p-2 bg-gray-800/50 rounded">
                    <div class="flex items-center">
                        ${statusIcon}
                        <span class="ml-2 font-bold">${name}</span>
                    </div>
                    <div class="text-right text-sm">
                        <div>${health.bars?.toLocaleString() || 0} bars</div>
                        <div class="text-gray-500 text-xs">${health.freshness_minutes || '?'} min ago</div>
                    </div>
                </div>
                ${!health.healthy ? `<div class="text-red-400 text-xs ml-6">${issues}</div>` : ''}`;
            }).join('');
            document.getElementById('parquetHealth').innerHTML = parquetHtml || '<span class="text-gray-500">No data</span>';

            // Signal Match
            const matchHtml = Object.entries(data.signal_match || {}).map(([name, match]) => {
                const statusIcon = match.match ? 
                    '<i class="fas fa-check-circle text-green-400"></i>' : 
                    '<i class="fas fa-times-circle text-red-400"></i>';
                const note = match.note ? `<div class="text-gray-500 text-xs">${match.note}</div>` : '';
                
                let diffsHtml = '';
                if (match.differences) {
                    diffsHtml = Object.entries(match.differences).map(([model, diff]) => {
                        const diffColor = diff > 5 ? 'text-red-400' : diff > 2 ? 'text-yellow-400' : 'text-green-400';
                        return `<span class="${diffColor}">${model.split('_')[0]}: ${diff}%</span>`;
                    }).join(' | ');
                }
                
                return `<div class="p-2 bg-gray-800/50 rounded">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            ${statusIcon}
                            <span class="ml-2 font-bold">${name}</span>
                        </div>
                        <span class="text-xs ${match.match ? 'text-green-400' : 'text-red-400'}">
                            ${match.match ? 'Match' : 'Mismatch'}
                        </span>
                    </div>
                    ${note}
                    <div class="text-xs text-gray-400 mt-1">${diffsHtml}</div>
                </div>`;
            }).join('');
            document.getElementById('signalMatch').innerHTML = matchHtml || '<span class="text-gray-500">No data</span>';

            // Backtest Section
            const backtest = data.backtest || {};
            if (backtest.last_run) {
                document.getElementById('backtestTime').textContent = `Last run: ${backtest.last_run}`;
                
                let backtestHtml = `
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-gray-800/50 rounded p-3 text-center">
                            <div class="text-2xl font-bold">${backtest.total_signals || 0}</div>
                            <div class="text-xs text-gray-500">Total Signals</div>
                        </div>
                        <div class="bg-gray-800/50 rounded p-3 text-center">
                            <div class="text-2xl font-bold text-green-400">${backtest.long_signals || 0}</div>
                            <div class="text-xs text-gray-500">üü¢ LONG</div>
                        </div>
                        <div class="bg-gray-800/50 rounded p-3 text-center">
                            <div class="text-2xl font-bold text-red-400">${backtest.short_signals || 0}</div>
                            <div class="text-xs text-gray-500">üî¥ SHORT</div>
                        </div>
                    </div>`;
                
                // Hourly summary chart
                if (backtest.hourly_summary && backtest.hourly_summary.length > 0) {
                    backtestHtml += `<div class="mb-4">
                        <div class="text-sm text-gray-400 mb-2">Hourly Max Probabilities (Last 12h)</div>
                        <div class="grid grid-cols-12 gap-1 text-xs">
                            ${backtest.hourly_summary.map(h => {
                                const longHeight = Math.min(h.long, 100);
                                const shortHeight = Math.min(h.short, 100);
                                const signalBg = h.signal === 'LONG' ? 'bg-green-500/30' : h.signal === 'SHORT' ? 'bg-red-500/30' : '';
                                return `<div class="text-center ${signalBg} rounded p-1">
                                    <div class="h-16 flex flex-col justify-end items-center gap-1">
                                        <div class="w-full bg-green-600 rounded-t" style="height: ${longHeight * 0.6}%"></div>
                                        <div class="w-full bg-red-600 rounded-b" style="height: ${shortHeight * 0.6}%"></div>
                                    </div>
                                    <div class="mt-1 text-gray-500">${h.hour.split(':')[0]}</div>
                                    ${h.signal ? `<div class="${h.signal === 'LONG' ? 'text-green-400' : 'text-red-400'}">‚óè</div>` : '<div class="text-transparent">‚óè</div>'}
                                </div>`;
                            }).join('')}
                        </div>
                        <div class="flex justify-center gap-4 mt-2 text-xs text-gray-500">
                            <span><span class="inline-block w-3 h-3 bg-green-600 rounded mr-1"></span>LONG %</span>
                            <span><span class="inline-block w-3 h-3 bg-red-600 rounded mr-1"></span>SHORT %</span>
                        </div>
                    </div>`;
                }
                
                // Recent signals
                if (backtest.recent_signals && backtest.recent_signals.length > 0) {
                    backtestHtml += `<div>
                        <div class="text-sm text-gray-400 mb-2">Recent Signals (‚â•65%)</div>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                            ${backtest.recent_signals.slice(-10).map(s => {
                                const isShort = s.model.includes('SHORT');
                                const icon = isShort ? 'üî¥' : 'üü¢';
                                const bgColor = isShort ? 'bg-red-900/30' : 'bg-green-900/30';
                                return `<div class="${bgColor} rounded p-2 text-xs">
                                    <div class="font-mono">${s.time}</div>
                                    <div>${icon} ${s.prob}%</div>
                                    <div class="text-gray-500">$${s.price?.toLocaleString()}</div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
                }
                
                document.getElementById('backtestContent').innerHTML = backtestHtml;
            } else {
                document.getElementById('backtestContent').innerHTML = '<div class="text-gray-500">Backtest runs 4x daily (00:00, 06:00, 12:00, 18:00 UTC)</div>';
            }
        }

        // Initial load
        loadStatus();
        
        // Refresh every 5 minutes
        setInterval(loadStatus, 5 * 60 * 1000);
    </script>
</body>
</html>
